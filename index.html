<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fluid Motion Booking v15 - Kickbike (Restore UPI API Call)</title> <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <style>
        /* --- Global Styles & Resets ---*/
        :root {
            /* Color Palette */
            --color-bg: #1a1a1a;
            --color-primary: #00FFFF; /* Electric Blue/Cyan */
            --color-secondary: #39FF14; /* Neon Green */
            --color-accent: #FF00FF; /* Vibrant Magenta */
            --color-text: #e0e0e0;
            --color-text-muted: #888888;
            --color-panel-bg: #2a2a2a;
            --color-panel-bg-translucent: rgba(42, 42, 42, 0.9);
            --color-border: #444444;
            --color-success: #39FF14;
            --color-warning: #FFA500;
            --color-error: #FF4136;

            /* Google Pay Colors (Approx) */
            --color-gpay-white: #FFFFFF;
            --color-gpay-dark-text: #333; /* Official GPay button background */

            /* Sizes & Transitions */
            --border-radius: 12px;
            --transition-speed: 0.3s;
            --dock-height-collapsed: 60px;
            --dock-height-expanded: 90px;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-size: 16px;
        }

        body {
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- Animated Background --- */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(-45deg, #1a1a1a, #2a2a2a, var(--color-primary), var(--color-bg));
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            opacity: 0.1;
            z-index: -1;
        }

        /* --- Screen Management --- */
        .screen {
            flex-grow: 1;
            overflow-y: auto;
            scroll-snap-type: y mandatory;
            padding: 20px 20px calc(var(--dock-height-expanded) + 30px) 20px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateX(100%);
            transition: opacity var(--transition-speed) ease-in-out,
                        visibility var(--transition-speed) ease-in-out,
                        transform var(--transition-speed) ease-in-out;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .screen::-webkit-scrollbar { display: none; }
        .screen { -ms-overflow-style: none; scrollbar-width: none; }


        .screen.is-active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
            z-index: 2;
        }

        #landing-screen {
            justify-content: center;
            text-align: center;
        }

        /* --- Typography --- */
        h1, h2, h3 {
            color: var(--color-primary);
            margin-bottom: 15px;
            font-weight: 700;
            scroll-snap-align: start;
        }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.8rem; }
        h3 { font-size: 1.4rem; }
        p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--color-text);
            scroll-snap-align: start;
        }
        .text-muted { color: var(--color-text-muted); }
        .text-success { color: var(--color-success); }
        .text-error { color: var(--color-error); }
        .text-center { text-align: center; }

        /* --- Buttons --- */
        .btn {
            display: inline-block;
            padding: 12px 25px;
            border: none;
            border-radius: var(--border-radius);
            background-color: var(--color-primary);
            color: var(--color-bg);
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
            text-align: center;
            margin: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn:hover {
            filter: brightness(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: scale(0.97);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            background-color: var(--color-text-muted);
            color: var(--color-panel-bg);
            cursor: not-allowed;
            box-shadow: none;
            filter: grayscale(50%);
        }


        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-bg);
        }

        .btn-accent {
            background-color: var(--color-accent);
            color: var(--color-text);
        }
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--color-primary);
            color: var(--color-primary);
            box-shadow: none;
        }
         .btn-outline:hover {
             background-color: rgba(0, 255, 255, 0.1);
             box-shadow: none;
         }
         .btn-outline:disabled {
             border-color: var(--color-text-muted);
             color: var(--color-text-muted);
             background-color: transparent;
         }


        .btn-block {
            display: block;
            width: 100%;
            margin-left: 0;
            margin-right: 0;
        }
        .btn-sm {
             padding: 8px 15px;
             font-size: 0.9rem;
        }
        .btn-error {
            background-color: var(--color-error);
            color: var(--color-text);
        }


        /* --- Google Pay Button Style (Text Only) --- */
        .btn-gpay {
            background-color: var(--color-gpay-dark-text);
            color: var(--color-gpay-white);
            padding: 10px 15px;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            min-height: 40px;
            min-width: 120px;
            font-weight: 500;
            font-family: 'Roboto', sans-serif;
            text-align: center;
        }

        .btn-gpay:hover:not(:disabled) {
            background-color: #4d4d4d;
            filter: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .btn-gpay:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #555555;
        }


        /* --- Bottom Dock Navigation --- */
        #bottom-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            height: var(--dock-height-collapsed);
            background-color: var(--color-panel-bg-translucent);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 10px;
            transition: height var(--transition-speed) ease-in-out;
            z-index: 100;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #bottom-dock.is-expanded {
            height: var(--dock-height-expanded);
            align-items: flex-start;
            padding-top: 10px;
        }

        .dock-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: color var(--transition-speed);
            flex-grow: 1;
            text-align: center;
            position: relative;
            overflow: hidden;
            padding: 5px;
            height: 100%;
             min-width: 50px;
        }
         #bottom-dock.is-expanded .dock-item {
             justify-content: flex-start;
             height: auto;
         }


        .dock-item i { /* Lucide icon */
            font-size: 24px;
            margin-bottom: 4px;
            transition: transform var(--transition-speed);
            pointer-events: none;
        }

        .dock-item span {
            font-size: 10px;
            opacity: 0;
            transition: opacity var(--transition-speed);
            max-height: 0;
            pointer-events: none;
            white-space: nowrap;
        }

        #bottom-dock.is-expanded .dock-item span {
            opacity: 1;
            max-height: 20px;
        }

        .dock-item.active {
            color: var(--color-primary);
        }
         .dock-item.active i {
            transform: scale(1.1);
         }

        .dock-item:hover {
            color: var(--color-text);
        }

        /* Ripple effect on click */
        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
            pointer-events: none;
        }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
            z-index: 1000;
        }

        .modal-overlay.is-active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--color-panel-bg);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform var(--transition-speed);
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            scroll-snap-type: y proximity;
        }
        .modal-content::-webkit-scrollbar { width: 5px; }
        .modal-content::-webkit-scrollbar-track { background: var(--color-border); border-radius: 3px;}
        .modal-content::-webkit-scrollbar-thumb { background: var(--color-text-muted); border-radius: 3px;}
        .modal-content::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }


        .modal-overlay.is-active .modal-content {
            transform: scale(1);
        }

        .modal-close-btn-corner {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            z-index: 10;
        }
        .modal-close-btn-corner:hover {
            color: var(--color-text);
        }
        .modal-close-btn-corner i { display: block; }

        .modal-action-close-btn {
            margin-top: 10px;
        }


        /* --- Specific Modal Styles --- */
        #payment-confirm-modal .modal-content {
            text-align: center;
        }

        /* Checkmark Animation */
        .checkmark-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--color-success);
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .checkmark {
            stroke: var(--color-bg);
            stroke-width: 5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.5s cubic-bezier(0.65, 0, 0.45, 1) 0.3s forwards;
        }
        @keyframes stroke {
            100% { stroke-dashoffset: 0; }
        }

        /* --- Bike List --- */
        #bike-list {
            list-style: none;
            padding: 0;
            width: 100%;
            max-width: 500px;
        }

        .bike-item {
            background-color: var(--color-panel-bg);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid var(--color-border);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            scroll-snap-align: start;
        }

        .bike-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.1);
        }

        .bike-info { flex-grow: 1; margin-right: 10px; }
        .bike-info h3 { margin-bottom: 5px; color: var(--color-text); font-size: 1.2rem;}
        .bike-info p { margin-bottom: 5px; font-size: 0.9rem; }
        .bike-actions { flex-shrink: 0; }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 20px;
            width: 100%;
            scroll-snap-align: start;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--color-primary);
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            color: var(--color-text);
            font-size: 1rem;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.2);
        }
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* --- Landing Screen Specific --- */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
            100% { transform: translateY(0px); }
        }
        #landing-kickbike-svg {
            width: 60%;
            max-width: 250px;
            height: auto;
            margin-bottom: 30px;
            animation: float 4s ease-in-out infinite;
            fill: var(--color-primary);
        }

        /* --- Active Ride Screen --- */
        #active-ride-content {
            text-align: center;
            width: 100%;
            max-width: 500px;
        }
        .ride-stat {
            background-color: var(--color-panel-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            scroll-snap-align: start;
        }
        .ride-stat .label {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: 5px;
            display: block;
        }
        .ride-stat .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-secondary);
        }

        /* --- Utility Classes --- */
        .mb-1 { margin-bottom: 5px !important; }
        .mb-2 { margin-bottom: 10px !important; }
        .mb-3 { margin-bottom: 15px !important; }
        .mb-4 { margin-bottom: 20px !important; }
        .mt-1 { margin-top: 5px !important; }
        .mt-2 { margin-top: 10px !important; }
        .mt-3 { margin-top: 15px !important; }
        .mt-4 { margin-top: 20px !important; }

        /* --- Back Button --- */
         #back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: rgba(42, 42, 42, 0.8);
            backdrop-filter: blur(5px);
            border: none;
            color: var(--color-text);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 90;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity var(--transition-speed), visibility var(--transition-speed), transform var(--transition-speed);
            opacity: 0;
            visibility: hidden;
            transform: scale(0.8);
         }
         #back-button.visible {
             opacity: 1;
             visibility: visible;
             transform: scale(1);
         }
         #back-button i { display: block; }

        /* --- Loader --- */
        .loader-overlay {
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background: rgba(0,0,0,0.6); display: flex; justify-content: center;
             align-items: center; z-index: 2000; opacity: 0; visibility: hidden;
             transition: opacity 0.3s, visibility 0.3s;
        }
        .loader-overlay.is-active { opacity: 1; visibility: visible; }
        .loader {
            border: 5px solid var(--color-panel-bg);
            border-top: 5px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <button id="back-button"><i data-lucide="arrow-left"></i></button>

    <div id="loader-overlay" class="loader-overlay">
        <div class="loader"></div>
    </div>

    <div id="landing-screen" class="screen is-active">
        <svg id="landing-kickbike-svg" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
            <circle cx="40" cy="80" r="15" stroke="currentColor" stroke-width="3" fill="none"/>
            <circle cx="160" cy="80" r="15" stroke="currentColor" stroke-width="3" fill="none"/>
            <line x1="40" y1="80" x2="160" y2="80" stroke="currentColor" stroke-width="3"/> <line x1="50" y1="80" x2="70" y2="30" stroke="currentColor" stroke-width="3"/> <line x1="70" y1="30" x2="80" y2="30" stroke="currentColor" stroke-width="3"/> <line x1="150" y1="80" x2="150" y2="50" stroke="currentColor" stroke-width="3"/> </svg>

        <h1>Fluid Motion</h1>
        <p class="text-muted mb-4">Your city, your ride. Unlock a kickbike instantly.</p>
        <button id="find-ride-btn" class="btn btn-secondary btn-block" data-target="bike-list-screen">Find a Ride</button>
    </div>

    <div id="bike-list-screen" class="screen">
        <h2>Available Kickbikes</h2>
        <ul id="bike-list">
            <li class="bike-item">
                <div class="bike-info">
                    <h3>Kickbike #101</h3>
                    <p class="text-muted">Near MG Road - 80% Battery</p>
                    <p><strong>₹5 / min</strong></p>
                </div>
                <div class="bike-actions">
                    <button class="btn btn-sm book-btn" data-bike-id="101" data-bike-name="Kickbike #101" data-rate="5.00" data-base-fare="20.00">Book Now</button>
                </div>
            </li>
            <li class="bike-item">
                <div class="bike-info">
                    <h3>Kickbike #237</h3>
                    <p class="text-muted">Panampilly Nagar - 95% Battery</p>
                    <p><strong>₹5 / min</strong></p>
                </div>
                 <div class="bike-actions">
                    <button class="btn btn-sm book-btn" data-bike-id="237" data-bike-name="Kickbike #237" data-rate="5.00" data-base-fare="20.00">Book Now</button>
                </div>
            </li>
             <li class="bike-item">
                <div class="bike-info">
                    <h3>Kickbike #42</h3>
                    <p class="text-muted">Marine Drive - 60% Battery</p>
                    <p><strong>₹7 / min</strong> (Boost Model)</p>
                </div>
                 <div class="bike-actions">
                    <button class="btn btn-sm book-btn" data-bike-id="42" data-bike-name="Kickbike #42 (Boost)" data-rate="7.00" data-base-fare="25.00">Book Now</button>
                </div>
            </li>
        </ul>
    </div>

    <div id="active-ride-screen" class="screen">
        <h2>Ride in Progress</h2>
        <div id="active-ride-content">
             <h3 id="active-ride-bike-name" class="mb-3">Kickbike #XXX</h3>
             <div class="ride-stat">
                 <span class="label">Duration</span>
                 <span class="value timer">00:00</span>
             </div>
             <div class="ride-stat">
                 <span class="label">Estimated Distance</span>
                 <span class="value distance">0.0 km</span>
             </div>
             <div class="ride-stat">
                 <span class="label">Estimated Ride Cost</span>
                 <span class="value cost">₹0.00</span>
             </div>
             <button id="end-ride-btn" class="btn btn-error btn-block mt-4">End Ride</button>
        </div>
    </div>

     <div id="ride-summary-screen" class="screen">
        <h2>Ride Summary</h2>
        <div id="ride-summary-content" class="text-center">
            <p>Thanks for riding with Fluid Motion!</p>
            <div class="ride-stat">
                 <span class="label">Final Duration</span>
                 <span class="value" id="summary-duration">--:--</span>
             </div>
             <div class="ride-stat">
                 <span class="label">Total Distance</span>
                 <span class="value" id="summary-distance">-.- km</span>
             </div>
             <div class="ride-stat">
                 <span class="label">Total Cost</span>
                 <span class="value" id="summary-cost">₹--.--</span>
             </div>
             <button class="btn btn-primary mt-4" data-target="landing-screen">Back to Home</button>
        </div>
    </div>

    <div id="about-screen" class="screen">
        <h2>About Fluid Motion</h2>
        <p>Fluid Motion provides easy and affordable urban mobility solutions through our network of shared electric kickbikes.</p>
        <p>Our mission is to make city travel faster, greener, and more enjoyable.</p>
        <img src="https://placehold.co/300x150/2a2a2a/00ffff?text=Our+Team" alt="Placeholder image of the team" style="border-radius: var(--border-radius); margin-top: 20px; max-width: 100%;">
    </div>

    <div id="help-screen" class="screen">
        <h2>Help & FAQ</h2>
        <h3>How do I start a ride?</h3>
        <p>Find a bike on the map (in the Bike List for this demo), tap 'Book Now', confirm the booking, and the bike will unlock.</p>
        <h3>How much does it cost?</h3>
        <p>Pricing includes an unlock fee (shown when booking) plus a per-minute rate (e.g., ₹5/min).</p>
        <h3>How do I end a ride?</h3>
        <p>Tap the 'End Ride' button on the active ride screen. Ensure you park the bike responsibly in a designated area.</p>
    </div>

    <div id="feedback-screen" class="screen">
        <h2>Send Feedback</h2>
        <form id="feedback-form" style="width: 100%; max-width: 500px;">
            <div class="form-group">
                <label for="feedback-type" class="form-label">Feedback Type</label>
                <select id="feedback-type" class="form-control">
                    <option value="general">General Inquiry</option>
                    <option value="bug">Report a Bug</option>
                    <option value="suggestion">Suggestion</option>
                    <option value="compliment">Compliment</option>
                </select>
            </div>
            <div class="form-group">
                <label for="feedback-message" class="form-label">Message</label>
                <textarea id="feedback-message" class="form-control" rows="4" required placeholder="Enter your message..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Submit Feedback</button>
        </form>
        <p id="feedback-thanks" class="text-success mt-3" style="display: none;">Thanks for your feedback!</p>
    </div>

    <div id="booking-confirm-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn-corner" data-modal-id="booking-confirm-modal" aria-label="Close modal">
                <i data-lucide="x"></i>
            </button>
            <h2>Confirm Booking</h2>
            <p>Book <strong id="modal-bike-name">Kickbike #XXX</strong>?</p>
            <p>Unlock Fee: <strong id="modal-bike-base-fare">₹XX.XX</strong></p>
            <p>Rate: <strong id="modal-bike-rate">₹X.XX / min</strong></p>
            <p class="text-muted mb-4">Unlock fee charged now. Ride duration charged later.</p>

            <button id="confirm-payment-btn" class="btn btn-gpay btn-block" disabled>
                 <span>Pay with GPay</span>
            </button>
            <p id="gpay-error-message" class="text-error" style="display: none; margin-top: 10px;"></p>

            <button class="btn btn-outline btn-block mt-2 modal-action-close-btn" data-modal-id="booking-confirm-modal">Cancel</button>
        </div>
    </div>

    <div id="payment-confirm-modal" class="modal-overlay">
        <div class="modal-content">
             <div class="checkmark-circle">
                 <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle-bg" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                 </svg>
             </div>
            <h2>Payment Successful!</h2>
            <p>Your booking is confirmed. Enjoy your ride!</p>
            <button class="btn btn-primary btn-block mt-4 modal-action-close-btn" data-modal-id="payment-confirm-modal">Start Ride</button>
        </div>
    </div>

    <nav id="bottom-dock">
        <div class="dock-item active" data-target="landing-screen" title="Home">
            <i data-lucide="home"></i>
            <span>Home</span>
        </div>
        <div class="dock-item" data-target="bike-list-screen" title="Find Ride">
            <i data-lucide="search"></i>
            <span>Find</span>
        </div>
         <div class="dock-item" data-target="active-ride-screen" title="Current Ride">
            <i data-lucide="navigation"></i>
            <span>Ride</span>
        </div>
        <div class="dock-item" data-target="help-screen" title="Help">
            <i data-lucide="help-circle"></i>
            <span>Help</span>
        </div>
        <div class="dock-item" data-target="about-screen" title="About">
             <i data-lucide="info"></i>
             <span>About</span>
        </div>
         <div class="dock-item" data-target="feedback-screen" title="Feedback">
             <i data-lucide="message-square"></i>
             <span>Feedback</span>
        </div>
    </nav>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // --- Google Pay API Configuration (UPI - India) ---
        const baseRequest = {
            apiVersion: 2,
            apiVersionMinor: 0
        };

        // IMPORTANT: Replace placeholders with your actual details from Google / Payment Gateway
        const payeeVpa = 'your-business-vpa@yourbank'; // Your business VPA
        const payeeName = 'Your Business Name'; // Your registered business name
        const merchantCode = '5499'; // Example MCC - Use your correct one!
        const gatewayName = 'example'; // Placeholder gateway name
        const gatewayMerchantId = 'exampleGatewayMerchantId'; // Placeholder gateway merchant ID

        const generateTransactionId = () => `FLUID-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;

        // Define UPI as the allowed payment method
        const allowedPaymentMethods = [{
            type: 'UPI',
            parameters: {
                payeeVpa: payeeVpa,
                payeeName: payeeName,
                mcc: merchantCode,
            },
            tokenizationSpecification: {
                // ** UPDATED: Using PAYMENT_GATEWAY as it's more common for UPI handling **
                // This assumes your gateway ('example') is configured to handle UPI via Google Pay
                // Consult your gateway documentation for the correct parameters.
                type: 'PAYMENT_GATEWAY',
                parameters: {
                    'gateway': gatewayName,
                    'gatewayMerchantId': gatewayMerchantId
                    // Add any other gateway-specific parameters needed for UPI here
                }
            }
        }];

        const merchantInfo = {
            merchantName: 'Fluid Motion Kickbikes (Test)'
            // merchantId might be required by your gateway, add if needed
        };

        let paymentsClient = null;

        // --- Basic App State & Elements ---
        const appState = {
            currentScreen: 'landing-screen',
            isBooking: false,
            activeRide: null,
            rideData: { durationSeconds: 0, distanceKm: 0, cost: 0 },
            historyStack: ['landing-screen'],
            gPayReady: false,
            currentBikeData: null
        };

        const elements = {
            screens: document.querySelectorAll('.screen'),
            dock: document.getElementById('bottom-dock'),
            dockItems: document.querySelectorAll('.dock-item'),
            backButton: document.getElementById('back-button'),
            loaderOverlay: document.getElementById('loader-overlay'),
            bookingConfirmModal: document.getElementById('booking-confirm-modal'),
            paymentConfirmModal: document.getElementById('payment-confirm-modal'),
            findRideBtn: document.getElementById('find-ride-btn'),
            confirmPaymentBtn: document.getElementById('confirm-payment-btn'),
            gpayErrorMessage: document.getElementById('gpay-error-message'),
            endRideBtn: document.getElementById('end-ride-btn'),
            modalBikeName: document.getElementById('modal-bike-name'),
            modalBikeRate: document.getElementById('modal-bike-rate'),
            modalBikeBaseFare: document.getElementById('modal-bike-base-fare'),
            activeRideBikeName: document.getElementById('active-ride-bike-name'),
            timerDisplay: document.querySelector('#active-ride-content .timer'),
            distanceDisplay: document.querySelector('#active-ride-content .distance'),
            costDisplay: document.querySelector('#active-ride-content .cost'),
            summaryDuration: document.getElementById('summary-duration'),
            summaryDistance: document.getElementById('summary-distance'),
            summaryCost: document.getElementById('summary-cost'),
            feedbackForm: document.getElementById('feedback-form'),
            feedbackThanks: document.getElementById('feedback-thanks'),
            bikeList: document.getElementById('bike-list')
        };


        // --- Utility Functions ---
        function showLoader() { elements.loaderOverlay.classList.add('is-active'); }
        function hideLoader() { elements.loaderOverlay.classList.remove('is-active'); }

        function navigateTo(screenId, isBack = false) {
            if (!screenId || screenId === appState.currentScreen) return;
            const currentScreenEl = document.getElementById(appState.currentScreen);
            const nextScreenEl = document.getElementById(screenId);
            if (!nextScreenEl) { console.error(`Screen ${screenId} not found.`); return; }

            if (!isBack && appState.historyStack[appState.historyStack.length - 1] !== screenId) {
                appState.historyStack.push(screenId);
            }

            if (currentScreenEl) currentScreenEl.classList.remove('is-active');
            nextScreenEl.classList.add('is-active');
            nextScreenEl.scrollTop = 0;

            appState.currentScreen = screenId;
            updateDockActiveState(screenId);
            updateBackButtonVisibility();
        }

        function updateDockActiveState(activeScreenId) {
            elements.dockItems.forEach(item => {
                const itemTarget = item.dataset.target;
                let isActive = (itemTarget === activeScreenId) ||
                               (itemTarget === 'active-ride-screen' && (activeScreenId === 'active-ride-screen' || activeScreenId === 'ride-summary-screen'));
                item.classList.toggle('active', isActive);
            });
        }

        function updateBackButtonVisibility() {
            const isVisible = appState.historyStack.length > 1;
            elements.backButton.classList.toggle('visible', isVisible);
        }

        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                 modal.classList.add('is-active');
                 const focusableElement = modal.querySelector('button:not([aria-label="Close modal"])');
                 focusableElement?.focus();
            }
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('is-active');
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function showGPayError(message = "Google Pay UPI is currently unavailable.") {
            elements.gpayErrorMessage.textContent = message;
            elements.gpayErrorMessage.style.display = 'block';
            elements.confirmPaymentBtn.disabled = true;
        }

        function hideGPayError() {
             elements.gpayErrorMessage.style.display = 'none';
        }

        // --- Google Pay Functions ---
        function getGooglePaymentsClient() {
            if (paymentsClient === null) {
                try {
                    // Ensure google.payments.api is available
                    if (window.google && google.payments && google.payments.api) {
                        paymentsClient = new google.payments.api.PaymentsClient({ environment: 'TEST' });
                        console.log("Google PaymentsClient initialized (TEST environment).");
                    } else {
                         console.error("Google Pay API script not loaded yet.");
                         showGPayError("Payment system loading...");
                         appState.gPayReady = false;
                         // Optionally, retry initialization after a short delay
                         // setTimeout(getGooglePaymentsClient, 500);
                    }
                } catch (error) {
                     console.error("Error initializing Google PaymentsClient:", error);
                     showGPayError("Could not initialize payment system.");
                     appState.gPayReady = false;
                }
            }
            return paymentsClient;
        }

        function checkGooglePayReady() {
            const client = getGooglePaymentsClient();
            if (!client) {
                 appState.gPayReady = false;
                 updateGPayButtonState();
                 // Show error if client couldn't be initialized
                 if (!paymentsClient) showGPayError("Could not initialize payment system.");
                 return;
            }

            const isReadyToPayRequest = { ...baseRequest, allowedPaymentMethods: allowedPaymentMethods };
            console.log("Checking GPay UPI readiness:", JSON.stringify(isReadyToPayRequest, null, 2));

            client.isReadyToPay(isReadyToPayRequest)
                .then(response => {
                    // *** RESTORED ACTUAL CHECK ***
                    appState.gPayReady = response.result;
                    console.log("Google Pay UPI Ready:", appState.gPayReady);
                    updateGPayButtonState(); // Enable/disable button based on actual readiness
                    if (!appState.gPayReady) {
                        showGPayError("Google Pay UPI is not available or not set up.");
                    } else {
                        hideGPayError(); // Hide error message if ready
                    }
                })
                .catch(err => {
                    // *** RESTORED ACTUAL ERROR HANDLING ***
                    console.error('isReadyToPay error (UPI): ', err);
                    appState.gPayReady = false;
                    updateGPayButtonState(); // Disable button on error
                    showGPayError(); // Show default error
                });
        }


        function updateGPayButtonState() {
             if (elements.confirmPaymentBtn) {
                // Enable/disable based on the actual readiness state
                elements.confirmPaymentBtn.disabled = !appState.gPayReady;
             }
         }

        function processPayment() {
            // Check actual readiness state
            if (!appState.gPayReady || !appState.currentBikeData) {
                console.error("GPay UPI not ready or bike data missing.");
                 showGPayError("Cannot initiate UPI payment."); // Keep showing error if not ready
                return;
            }
            const client = getGooglePaymentsClient();
            // Ensure client is valid before proceeding
            if (!client) {
                 console.error("PaymentsClient not available in processPayment.");
                 showGPayError("Payment system error.");
                 return;
            }

            const currentTransactionId = generateTransactionId();
            const transactionNote = `Unlock ${appState.currentBikeData.name}`;

            const transactionInfo = {
                countryCode: 'IN',
                currencyCode: 'INR',
                totalPriceStatus: 'FINAL',
                totalPrice: appState.currentBikeData.baseFare.toFixed(2),
                totalPriceLabel: 'Total Unlock Fee',
                transactionId: currentTransactionId,
                // transactionNote: transactionNote, // Note: Often added in allowedPaymentMethods parameters instead
            };

            // It's safer to create a deep copy if modifying nested objects
            const dynamicAllowedPaymentMethods = JSON.parse(JSON.stringify(allowedPaymentMethods));
            // Add dynamic parameters if needed by your specific UPI config/gateway
            dynamicAllowedPaymentMethods[0].parameters.transactionNote = transactionNote; // Example if needed here

            const paymentDataRequest = {
                ...baseRequest,
                allowedPaymentMethods: dynamicAllowedPaymentMethods, // Use potentially updated object
                transactionInfo: transactionInfo,
                merchantInfo: merchantInfo
            };

            console.log("Requesting UPI payment data:", JSON.stringify(paymentDataRequest, null, 2));
            showLoader();

            // *** RESTORED ACTUAL API CALL ***
            client.loadPaymentData(paymentDataRequest)
                .then(paymentData => {
                    // This block now executes only if the API call succeeds
                    console.log('UPI Payment Success (Raw Data):', paymentData);
                    // *** SEND paymentData TO YOUR BACKEND FOR VERIFICATION/PROCESSING ***
                    setTimeout(() => { // Simulate backend confirmation
                        hideLoader();
                        hideModal('booking-confirm-modal');
                        showModal('payment-confirm-modal');
                        appState.activeRide = {
                            bikeId: appState.currentBikeData.id,
                            bikeName: appState.currentBikeData.name,
                            rate: appState.currentBikeData.rate,
                            baseFare: appState.currentBikeData.baseFare,
                            startTime: new Date(),
                            timerInterval: null,
                            distanceInterval: null
                        };
                        elements.activeRideBikeName.textContent = appState.currentBikeData.name;
                        appState.isBooking = false;
                        // Keep currentBikeData for summary calculation
                    }, 1500);

                })
                .catch(err => {
                    // This block now executes if the API call fails
                    hideLoader();
                    console.error('loadPaymentData error (UPI): ', err);
                    let userMessage = "UPI Payment failed or was cancelled.";
                    // Check for specific error codes
                    if (err.statusCode === 'CANCELED') {
                         userMessage = "Payment cancelled.";
                    } else if (err.statusCode === 'DEVELOPER_ERROR') {
                         // THIS IS LIKELY STILL THE ERROR YOU WILL SEE WITH PLACEHOLDERS
                         userMessage = "Payment configuration error. Check VPA/Gateway details.";
                         console.warn("DEVELOPER_ERROR likely due to placeholder VPA/Gateway configuration. Replace with real details.");
                    } else if (err.statusCode === 'INTERNAL_ERROR') {
                         userMessage = "Internal Google Pay error. Please try again.";
                    }
                    showGPayError(userMessage); // Show specific error
                    appState.isBooking = false; // Reset booking state
                    appState.currentBikeData = null; // Clear bike data on failure
                });
        }


        // --- Ride Simulation Logic ---
        function startRideTimer() {
            if (appState.activeRide?.timerInterval) clearInterval(appState.activeRide.timerInterval);
            if (appState.activeRide?.distanceInterval) clearInterval(appState.activeRide.distanceInterval);
            if (!appState.activeRide) return;

            appState.rideData = { durationSeconds: 0, distanceKm: 0, cost: 0 };
            updateRideDisplay();

            appState.activeRide.timerInterval = setInterval(() => {
                appState.rideData.durationSeconds++;
                const ratePerSecond = appState.activeRide.rate / 60;
                appState.rideData.cost = appState.rideData.durationSeconds * ratePerSecond;
                updateRideDisplay();
            }, 1000);

             const avgSpeedKps = 15 / 3600;
             const updateIntervalMs = 2000;
             appState.activeRide.distanceInterval = setInterval(() => {
                 appState.rideData.distanceKm += avgSpeedKps * (updateIntervalMs / 1000);
                 updateRideDisplay();
             }, updateIntervalMs);
        }

        function stopRideTimer() {
            if (appState.activeRide) {
                clearInterval(appState.activeRide.timerInterval);
                clearInterval(appState.activeRide.distanceInterval);
                appState.activeRide.timerInterval = null;
                appState.activeRide.distanceInterval = null;
            }
        }

        function updateRideDisplay() {
            if (elements.timerDisplay) elements.timerDisplay.textContent = formatTime(appState.rideData.durationSeconds);
            if (elements.distanceDisplay) elements.distanceDisplay.textContent = `${appState.rideData.distanceKm.toFixed(1)} km`;
            if (elements.costDisplay) elements.costDisplay.textContent = `₹${appState.rideData.cost.toFixed(2)}`;
        }


        function endRide() {
            if (!appState.activeRide) return;
            showLoader();
            stopRideTimer();
            setTimeout(() => {
                 const totalCost = (appState.activeRide.baseFare || 0) + appState.rideData.cost;
                elements.summaryDuration.textContent = formatTime(appState.rideData.durationSeconds);
                elements.summaryDistance.textContent = `${appState.rideData.distanceKm.toFixed(1)} km`;
                elements.summaryCost.textContent = `₹${totalCost.toFixed(2)}`;
                appState.activeRide = null;
                appState.isBooking = false;
                appState.currentBikeData = null;
                hideLoader();
                navigateTo('ride-summary-screen');
            }, 1500);
        }

        // --- Event Handlers ---
        function handleDockClick(event) {
            const targetItem = event.target.closest('.dock-item');
            if (!targetItem) return;
            const targetScreen = targetItem.dataset.target;
            if (targetScreen === 'active-ride-screen' && !appState.activeRide) {
                 console.log("No active ride.");
                 updateDockActiveState(appState.currentScreen);
                 return;
            }
            navigateTo(targetScreen);
            createRipple(event, targetItem);
        }

        function createRipple(event, element) {
            const ripple = document.createElement('span');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            ripple.classList.add('ripple');
            const existingRipple = element.querySelector('.ripple');
            if (existingRipple) existingRipple.remove();
            element.appendChild(ripple);
            ripple.addEventListener('animationend', () => { if (ripple.parentNode) ripple.remove(); }, { once: true });
        }

        function handleBookNowClick(event) {
            if (appState.isBooking) return;
            const button = event.target.closest('.book-btn');
            if (!button) return;

            appState.currentBikeData = {
                id: button.dataset.bikeId,
                name: button.dataset.bikeName,
                rate: parseFloat(button.dataset.rate),
                baseFare: parseFloat(button.dataset.baseFare || '0.00')
            };

            elements.modalBikeName.textContent = appState.currentBikeData.name;
            elements.modalBikeRate.textContent = `₹${appState.currentBikeData.rate.toFixed(2)} / min`;
            elements.modalBikeBaseFare.textContent = `₹${appState.currentBikeData.baseFare.toFixed(2)}`;

            checkGooglePayReady(); // Check actual readiness now
            // hideGPayError() is called within checkGooglePayReady if successful
            showModal('booking-confirm-modal');
        }

        function handleModalClose(event) {
            const button = event.target.closest('[data-modal-id]');
            if (!button) return;
            const modalId = button.dataset.modalId;
            if (modalId) {
                hideModal(modalId);
                if (modalId === 'payment-confirm-modal') {
                     navigateTo('active-ride-screen');
                     startRideTimer();
                }
                if (modalId === 'booking-confirm-modal') {
                     appState.isBooking = false;
                     appState.currentBikeData = null;
                     hideGPayError();
                }
            }
        }

        function handleFeedbackSubmit(event) {
             event.preventDefault();
             showLoader();
             setTimeout(() => {
                 elements.feedbackForm.reset();
                 hideLoader();
                 elements.feedbackThanks.style.display = 'block';
                 setTimeout(() => { elements.feedbackThanks.style.display = 'none'; }, 3000);
             }, 1000);
         }

        function handleBackClick() {
             if (appState.historyStack.length > 1) {
                 appState.historyStack.pop();
                 const previousScreenId = appState.historyStack[appState.historyStack.length - 1];
                 navigateTo(previousScreenId, true);
             }
         }

        // --- Initialization ---
        function initializeApp() {
            console.log('DOM Loaded. Initializing app v15 (Restore UPI API Call)...'); // Updated log
            lucide.createIcons();
            getGooglePaymentsClient(); // Attempt to initialize client early

            // Attach Event Listeners
            elements.dock.addEventListener('click', handleDockClick);
            elements.dock.addEventListener('click', (e) => {
                 if (!e.target.closest('.dock-item')) elements.dock.classList.toggle('is-expanded');
                 else setTimeout(() => elements.dock.classList.remove('is-expanded'), 150);
            });
            document.body.addEventListener('click', (e) => {
                 if (!elements.dock.contains(e.target) && !e.target.closest('.dock-item')) {
                     elements.dock.classList.remove('is-expanded');
                 }
            }, true);
            elements.findRideBtn?.addEventListener('click', () => navigateTo(elements.findRideBtn.dataset.target));
            document.querySelectorAll('button[data-target]:not(#find-ride-btn):not(.book-btn)').forEach(el => {
                 if(!el.closest('#bottom-dock')) el.addEventListener('click', () => navigateTo(el.dataset.target));
            });
            elements.bikeList?.addEventListener('click', handleBookNowClick);
            elements.confirmPaymentBtn?.addEventListener('click', processPayment);
            document.body.addEventListener('click', handleModalClose);
            elements.endRideBtn?.addEventListener('click', endRide);
            elements.backButton.addEventListener('click', handleBackClick);
            elements.feedbackForm?.addEventListener('submit', handleFeedbackSubmit);

            // Initial State Setup
            updateDockActiveState(appState.currentScreen);
            updateBackButtonVisibility();
            updateGPayButtonState(); // Set initial button state (likely disabled)
            console.log('App Initialized.');
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
